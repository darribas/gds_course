

<!DOCTYPE html>


<html >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Hands-on &#8212; A course on Geographic Data Science</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=e353d410970836974a52" rel="stylesheet" />
<link href="../../_static/styles/bootstrap.css?digest=e353d410970836974a52" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=e353d410970836974a52" rel="stylesheet" />

  
  <link href="../../_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=e353d410970836974a52" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" href="../../_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/custom.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=e353d410970836974a52" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52" />

    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/clipboard.min.js"></script>
    <script src="../../_static/copybutton.js"></script>
    <script src="../../_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../../_static/design-tabs.js"></script>
    <script async="async" src="https://www.googletagmanager.com/gtag/js?id=UA-6032674-1"></script>
    <script>
                window.dataLayer = window.dataLayer || [];
                function gtag(){ dataLayer.push(arguments); }
                gtag('js', new Date());
                gtag('config', 'UA-6032674-1');
            </script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../../_static/sphinx-thebe.js"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'content/bE/lab_E';</script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Do-It-Yourself" href="diy_E.html" />
    <link rel="prev" title="Concepts" href="concepts_E.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="None"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <nav class="bd-header navbar navbar-expand-lg bd-navbar">
    </nav>
  
  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
  

<a class="navbar-brand logo" href="../home.html">
  
  
  
  
  
    <p class="title logo__title">A course on Geographic Data Science</p>
  
</a></div>
        <div class="sidebar-primary-item"><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../home.html">
                    ENVS363/563
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Information</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../overview.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../infrastructure.html">Infrastructure</a></li>
<li class="toctree-l1"><a class="reference internal" href="../assessment.html">Assessment</a></li>
<li class="toctree-l1"><a class="reference internal" href="../datasets.html">Datasets</a></li>
<li class="toctree-l1"><a class="reference internal" href="../bibliography.html">Bibliography</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">A - Introduction</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../bA/concepts_A.html">Concepts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../bA/lab_A.html">Hands-on</a></li>
<li class="toctree-l1"><a class="reference internal" href="../bA/diy_A.html">Do-It-Yourself</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">B - Open Science</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../bB/concepts_B.html">Concepts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../bB/lab_B.html">Hands-on</a></li>
<li class="toctree-l1"><a class="reference internal" href="../bB/diy_B.html">Do-It-Yourself</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">C - Spatial Data</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../bC/concepts_C.html">Concepts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../bC/lab_C.html">Hands-on</a></li>
<li class="toctree-l1"><a class="reference internal" href="../bC/diy_C.html">Do-It-Yourself</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">D - Mapping Data</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../bD/concepts_D.html">Concepts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../bD/lab_D.html">Hands-on</a></li>
<li class="toctree-l1"><a class="reference internal" href="../bD/diy_D.html">Do-It-Yourself</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">E - Spatial Weights</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="concepts_E.html">Concepts</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Hands-on</a></li>
<li class="toctree-l1"><a class="reference internal" href="diy_E.html">Do-It-Yourself</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">F - ESDA</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../bF/concepts_F.html">Concepts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../bF/lab_F.html">Hands-on</a></li>
<li class="toctree-l1"><a class="reference internal" href="../bF/diy_F.html">Do-It-Yourself</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">G - Clustering</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../bG/concepts_G.html">Concepts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../bG/lab_G.html">Hands-on</a></li>
<li class="toctree-l1"><a class="reference internal" href="../bG/diy_G.html">Do-It-Yourself</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">H - Points</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../bH/concepts_H.html">Concepts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../bH/lab_H.html">Hands-on</a></li>
<li class="toctree-l1"><a class="reference internal" href="../bH/diy_H.html">Do-It-Yourself</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-launch-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Launch interactive content">
    <i class="fas fa-rocket"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://mybinder.org/v2/gh/darribas/gds_course/master?urlpath=tree/content/bE/lab_E.ipynb" target="_blank"
   class="btn btn-sm dropdown-item"
   title="Launch onBinder"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  
    <img src="../../_static/images/logo_binder.svg">
  </span>
<span class="btn__text-container">Binder</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../../_sources/content/bE/lab_E.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>


<script>
document.write(`
  <button class="theme-switch-button btn btn-sm btn-outline-primary navbar-btn rounded-circle" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch" data-mode="light"><i class="fa-solid fa-sun"></i></span>
    <span class="theme-switch" data-mode="dark"><i class="fa-solid fa-moon"></i></span>
    <span class="theme-switch" data-mode="auto"><i class="fa-solid fa-circle-half-stroke"></i></span>
  </button>
`);
</script>

<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Hands-on</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#spatial-weights">Spatial weights</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#data">Data</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#building-spatial-weights-in-pysal">Building spatial weights in <code class="docutils literal notranslate"><span class="pre">PySAL</span></code></a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#contiguity">Contiguity</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#distance">Distance</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#block-weights">Block weights</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#standardizing-w-matrices">Standardizing <code class="docutils literal notranslate"><span class="pre">W</span></code> matrices</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#reading-and-writing-spatial-weights-in-pysal">Reading and Writing spatial weights in <code class="docutils literal notranslate"><span class="pre">PySAL</span></code></a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#spatial-lag">Spatial Lag</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#moran-plot">Moran Plot</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article" role="main">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="hands-on">
<h1>Hands-on<a class="headerlink" href="#hands-on" title="Permalink to this headline">#</a></h1>
<section id="spatial-weights">
<h2>Spatial weights<a class="headerlink" href="#spatial-weights" title="Permalink to this headline">#</a></h2>
<p>In this session we will be learning the ins and outs of one of the key pieces in spatial analysis: spatial weights matrices. These are structured sets of numbers that formalize geographical relationships between the observations in a dataset. Essentially, a spatial weights matrix of a given geography is a positive definite matrix of dimensions <span class="math notranslate nohighlight">\(N\)</span> by <span class="math notranslate nohighlight">\(N\)</span>, where <span class="math notranslate nohighlight">\(N\)</span> is the total number of observations:</p>
<div class="math notranslate nohighlight">
\[\begin{split}
W = \left(\begin{array}{cccc}
0 &amp; w_{12} &amp; \dots &amp; w_{1N} \\
w_{21} &amp; \ddots &amp; w_{ij} &amp; \vdots \\
\vdots &amp; w_{ji} &amp; 0 &amp; \vdots \\
w_{N1} &amp; \dots &amp; \dots &amp; 0 
\end{array} \right)
\end{split}\]</div>
<p>where each cell <span class="math notranslate nohighlight">\(w_{ij}\)</span> contains a value that represents the degree of spatial contact or interaction between observations <span class="math notranslate nohighlight">\(i\)</span> and <span class="math notranslate nohighlight">\(j\)</span>. A fundamental concept in this context is that of <em>neighbor</em> and <em>neighborhood</em>. By convention, elements in the diagonal (<span class="math notranslate nohighlight">\(w_{ii}\)</span>) are set to zero. A <em>neighbor</em> of a given observation <span class="math notranslate nohighlight">\(i\)</span> is another observation with which <span class="math notranslate nohighlight">\(i\)</span> has some degree of connection. In terms of <span class="math notranslate nohighlight">\(W\)</span>, <span class="math notranslate nohighlight">\(i\)</span> and <span class="math notranslate nohighlight">\(j\)</span> are thus neighbors if <span class="math notranslate nohighlight">\(w_{ij} &gt; 0\)</span>. Following this logic, the neighborhood of <span class="math notranslate nohighlight">\(i\)</span> will be the set of observations in the system with which it has certain connection, or those observations with a weight greater than zero.</p>
<p>There are several ways to create such matrices, and many more to transform them so they contain an accurate representation that aligns with the way we understand spatial interactions between the elements of a system. In this session, we will introduce the most commonly used ones and will show how to compute them with <code class="docutils literal notranslate"><span class="pre">PySAL</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">matplotlib</span> inline

<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">pysal.lib</span> <span class="kn">import</span> <span class="n">weights</span>
<span class="kn">from</span> <span class="nn">libpysal.io</span> <span class="kn">import</span> <span class="nb">open</span> <span class="k">as</span> <span class="n">psopen</span>
<span class="kn">import</span> <span class="nn">geopandas</span> <span class="k">as</span> <span class="nn">gpd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="data">
<h2>Data<a class="headerlink" href="#data" title="Permalink to this headline">#</a></h2>
<p>For this tutorial, we will use a dataset of Liverpool small areas (or Lower layer Super Output Areas, LSOAs) for Liverpool. The table is available as part of this course, so can be accessed remotely through the web. If you want to see how the table was created, a notebook is available <a class="reference internal" href="../data/liv_lsoas_prep.html"><span class="doc std std-doc">here</span></a>.</p>
<p>To make things easier, we will read data from a file posted online so, for now, you do not need to download any dataset:</p>
<aside class="margin sidebar">
<p class="sidebar-title"></p>
<div class="admonition-important admonition">
<p class="admonition-title">Important</p>
<p>Make sure you are connected to the internet when you run this cell</p>
</div>
</aside>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Read the file in</span>
<span class="n">db</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span>
    <span class="s2">&quot;https://darribas.org/gds_course/content/data/liv_lsoas.gpkg&quot;</span>
<span class="p">)</span>
<span class="c1"># Index table on the LSOA ID</span>
<span class="n">db</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;LSOA11CD&quot;</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="c1"># Display summary</span>
<span class="n">db</span><span class="o">.</span><span class="n">info</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;class &#39;geopandas.geodataframe.GeoDataFrame&#39;&gt;
Index: 298 entries, E01006512 to E01033768
Data columns (total 3 columns):
 #   Column    Non-Null Count  Dtype   
---  ------    --------------  -----   
 0   LSOA11CD  298 non-null    object  
 1   MSOA11CD  298 non-null    object  
 2   geometry  298 non-null    geometry
dtypes: geometry(1), object(2)
memory usage: 9.3+ KB
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/opt/conda/lib/python3.8/site-packages/geopandas/geodataframe.py:577: RuntimeWarning: Sequential read of iterator was interrupted. Resetting iterator. This can negatively impact the performance.
  for feature in features_lst:
</pre></div>
</div>
</div>
</div>
<div class="admonition-alternative admonition">
<p class="admonition-title">Alternative</p>
<p>Instead of reading the file directly off the web, it is possible to download it manually, store it on your computer, and read it locally. To do that, you can follow these steps:</p>
<ol class="arabic simple">
<li><p>Download the file by right-clicking on <a href="../data/liv_lsoas.gpkg"> this link </a> and saving the file</p></li>
<li><p>Place the file on the <em>same folder as the notebook</em> where you intend to read it</p></li>
<li><p>Replace the code in the cell above by:</p></li>
</ol>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="s2">&quot;liv_lsoas.gpkg&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</section>
<section id="building-spatial-weights-in-pysal">
<h2>Building spatial weights in <code class="docutils literal notranslate"><span class="pre">PySAL</span></code><a class="headerlink" href="#building-spatial-weights-in-pysal" title="Permalink to this headline">#</a></h2>
<section id="contiguity">
<h3>Contiguity<a class="headerlink" href="#contiguity" title="Permalink to this headline">#</a></h3>
<p>Contiguity weights matrices define spatial connections through the existence of common boundaries. This makes it directly suitable to use with polygons: if two polygons share boundaries to some degree, they will be labeled as neighbors under these kinds of weights. Exactly how much they need to share is what differenciates the two approaches we will learn: queen and rook.</p>
<ul class="simple">
<li><p><strong>Queen</strong></p></li>
</ul>
<p>Under the queen criteria, two observations only need to share a vortex (a single point) of their boundaries to be considered neighbors. Constructing a weights matrix under these principles can be done by running:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">w_queen</span> <span class="o">=</span> <span class="n">weights</span><span class="o">.</span><span class="n">Queen</span><span class="o">.</span><span class="n">from_dataframe</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">idVariable</span><span class="o">=</span><span class="s2">&quot;LSOA11CD&quot;</span><span class="p">)</span>
<span class="n">w_queen</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;libpysal.weights.contiguity.Queen at 0x7fba3879f910&gt;
</pre></div>
</div>
</div>
</div>
<p>The command above creates an object <code class="docutils literal notranslate"><span class="pre">w_queen</span></code> of the class <code class="docutils literal notranslate"><span class="pre">W</span></code>. This is the format in which spatial weights matrices are stored in <code class="docutils literal notranslate"><span class="pre">PySAL</span></code>. By default, the weights builder (<code class="docutils literal notranslate"><span class="pre">Queen.from_dataframe</span></code>) will use the index of the table, which is useful so we can keep everything in line easily.</p>
<p>A <code class="docutils literal notranslate"><span class="pre">W</span></code> object can be queried to find out about the contiguity relations it contains. For example, if we would like to know who is a neighbor of observation <code class="docutils literal notranslate"><span class="pre">E01006690</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">w_queen</span><span class="p">[</span><span class="s1">&#39;E01006690&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;E01006697&#39;: 1.0,
 &#39;E01006692&#39;: 1.0,
 &#39;E01033763&#39;: 1.0,
 &#39;E01006759&#39;: 1.0,
 &#39;E01006695&#39;: 1.0,
 &#39;E01006720&#39;: 1.0,
 &#39;E01006691&#39;: 1.0}
</pre></div>
</div>
</div>
</div>
<p>This returns a Python dictionary that contains the ID codes of each neighbor as keys, and the weights they are assigned as values. Since we are looking at a raw queen contiguity matrix, every neighbor gets a weight of one. If we want to access the weight of a specific neighbor, <code class="docutils literal notranslate"><span class="pre">E01006691</span></code> for example, we can do recursive querying:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">w_queen</span><span class="p">[</span><span class="s1">&#39;E01006690&#39;</span><span class="p">][</span><span class="s1">&#39;E01006691&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1.0
</pre></div>
</div>
</div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">W</span></code> objects also have a direct way to provide a list of all the neighbors or their weights for a given observation. This is thanks to the <code class="docutils literal notranslate"><span class="pre">neighbors</span></code> and <code class="docutils literal notranslate"><span class="pre">weights</span></code> attributes:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">w_queen</span><span class="o">.</span><span class="n">neighbors</span><span class="p">[</span><span class="s1">&#39;E01006690&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;E01006697&#39;,
 &#39;E01006692&#39;,
 &#39;E01033763&#39;,
 &#39;E01006759&#39;,
 &#39;E01006695&#39;,
 &#39;E01006720&#39;,
 &#39;E01006691&#39;]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">w_queen</span><span class="o">.</span><span class="n">weights</span><span class="p">[</span><span class="s1">&#39;E01006690&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0]
</pre></div>
</div>
</div>
</div>
<p>Once created, <code class="docutils literal notranslate"><span class="pre">W</span></code> objects can provide much information about the matrix, beyond the basic attributes one would expect. We have direct access to the number of neighbors each observation has via the attribute <code class="docutils literal notranslate"><span class="pre">cardinalities</span></code>. For example, to find out how many neighbors observation <code class="docutils literal notranslate"><span class="pre">E01006524</span></code> has:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">w_queen</span><span class="o">.</span><span class="n">cardinalities</span><span class="p">[</span><span class="s1">&#39;E01006524&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>6
</pre></div>
</div>
</div>
</div>
<p>Since <code class="docutils literal notranslate"><span class="pre">cardinalities</span></code> is a dictionary, it is direct to convert it into a <code class="docutils literal notranslate"><span class="pre">Series</span></code> object:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">queen_card</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">w_queen</span><span class="o">.</span><span class="n">cardinalities</span><span class="p">)</span>
<span class="n">queen_card</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>E01006512    6
E01006513    9
E01006514    5
E01006515    8
E01006518    5
dtype: int64
</pre></div>
</div>
</div>
</div>
<p>This allows, for example, to access quick plotting, which comes in very handy to get an overview of the size of neighborhoods in general:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sns</span><span class="o">.</span><span class="n">distplot</span><span class="p">(</span><span class="n">queen_card</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/opt/conda/lib/python3.8/site-packages/seaborn/distributions.py:2557: FutureWarning: `distplot` is a deprecated function and will be removed in a future version. Please adapt your code to use either `displot` (a figure-level function with similar flexibility) or `histplot` (an axes-level function for histograms).
  warnings.warn(msg, FutureWarning)
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;AxesSubplot:ylabel=&#39;Density&#39;&gt;
</pre></div>
</div>
<img alt="../../_images/8f644a9420a58fe54be249e418f2b99bbd4f1cbb99e8e9e3d4074c2333117d8c.png" src="../../_images/8f644a9420a58fe54be249e418f2b99bbd4f1cbb99e8e9e3d4074c2333117d8c.png" />
</div>
</div>
<p>The figure above shows how most observations have around five neighbors, but there is some variation around it. The distribution also seems to follow a symmetric form, where deviations from the average occur both in higher and lower values almost evenly.</p>
<p>Some additional information about the spatial relationships contained in the matrix are also easily available from a <code class="docutils literal notranslate"><span class="pre">W</span></code> object. Let us tour over some of them:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Number of observations</span>
<span class="n">w_queen</span><span class="o">.</span><span class="n">n</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>298
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Average number of neighbors</span>
<span class="n">w_queen</span><span class="o">.</span><span class="n">mean_neighbors</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>5.617449664429531
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Min number of neighbors</span>
<span class="n">w_queen</span><span class="o">.</span><span class="n">min_neighbors</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Max number of neighbors</span>
<span class="n">w_queen</span><span class="o">.</span><span class="n">max_neighbors</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>11
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Islands (observations disconnected)</span>
<span class="n">w_queen</span><span class="o">.</span><span class="n">islands</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Order of IDs (first five only in this case)</span>
<span class="n">w_queen</span><span class="o">.</span><span class="n">id_order</span><span class="p">[:</span><span class="mi">5</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;E01006512&#39;, &#39;E01006513&#39;, &#39;E01006514&#39;, &#39;E01006515&#39;, &#39;E01006518&#39;]
</pre></div>
</div>
</div>
</div>
<p>Spatial weight matrices can be explored visually in other ways. For example, we can pick an observation and visualize it in the context of its neighborhood. The following plot does exactly that by zooming into the surroundings of LSOA <code class="docutils literal notranslate"><span class="pre">E01006690</span></code> and displaying its polygon as well as those of its neighbors:</p>
<div class="cell docutils container" id="lab-e-queen-zoom">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Setup figure</span>
<span class="n">f</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="c1"># Plot base layer of polygons</span>
<span class="n">db</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
<span class="c1"># Select focal polygon</span>
<span class="c1"># NOTE we pass both the area code and the column name</span>
<span class="c1">#      (`geometry`) within brackets!!!</span>
<span class="n">focus</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">loc</span><span class="p">[[</span><span class="s1">&#39;E01006690&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">]]</span>
<span class="c1"># Plot focal polygon</span>
<span class="n">focus</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
<span class="c1"># Plot neighbors</span>
<span class="n">neis</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">w_queen</span><span class="p">[</span><span class="s1">&#39;E01006690&#39;</span><span class="p">],</span> <span class="p">:]</span>
<span class="n">neis</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;lime&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="c1"># Title</span>
<span class="n">f</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;Queen neighbors of `E01006690`&quot;</span><span class="p">)</span>
<span class="c1"># Style and display on screen</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">388000</span><span class="p">,</span> <span class="mi">393500</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">336000</span><span class="p">,</span> <span class="mi">339500</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/b603dd6c92e0bf8e9132d9606222d8c026ea36c91723477912e13d7ef68061de.png" src="../../_images/b603dd6c92e0bf8e9132d9606222d8c026ea36c91723477912e13d7ef68061de.png" />
</div>
</div>
<p>Note how the figure is built gradually, from the base map (L. 4-5), to the focal point (L. 9), to its neighborhood (L. 11-13). Once the entire figure is plotted, we zoom into the area of interest (L. 19-20).</p>
<ul class="simple">
<li><p><strong>Rook</strong></p></li>
</ul>
<p>Rook contiguity is similar to and, in many ways, superseded by queen contiguity. However, since it sometimes comes up in the literature, it is useful to know about it. The main idea is the same: two observations are neighbors if they share some of their boundary lines. However, in the rook case, it is not enough with sharing only one point, it needs to be at least a segment of their boundary. In most applied cases, these differences usually boil down to how the geocoding was done, but in some cases, such as when we use raster data or grids, this approach can differ more substantively and it thus makes more sense.</p>
<p>From a technical point of view, constructing a rook matrix is very similar:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">w_rook</span> <span class="o">=</span> <span class="n">weights</span><span class="o">.</span><span class="n">Rook</span><span class="o">.</span><span class="n">from_dataframe</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
<span class="n">w_rook</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;libpysal.weights.contiguity.Rook at 0x7fba38676df0&gt;
</pre></div>
</div>
</div>
</div>
<p>The output is of the same type as before, a <code class="docutils literal notranslate"><span class="pre">W</span></code> object that can be queried and used in very much the same way as any other one.</p>
</section>
<section id="distance">
<h3>Distance<a class="headerlink" href="#distance" title="Permalink to this headline">#</a></h3>
<p>Distance based matrices assign the weight to each pair of observations as a function of how far from each other they are. How this is translated into an actual weight varies across types and variants, but they all share that the ultimate reason why two observations are assigned some weight is due to the distance between them.</p>
<ul class="simple">
<li><p><strong>K-Nearest Neighbors</strong></p></li>
</ul>
<p>One approach to define weights is to take the distances between a given observation and the rest of the set, rank them, and consider as neighbors the <span class="math notranslate nohighlight">\(k\)</span> closest ones. That is exactly what the <span class="math notranslate nohighlight">\(k\)</span>-nearest neighbors (KNN) criterium does.</p>
<p>To calculate KNN weights, we can use a similar function as before and derive them from a shapefile:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">knn5</span> <span class="o">=</span> <span class="n">weights</span><span class="o">.</span><span class="n">KNN</span><span class="o">.</span><span class="n">from_dataframe</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
<span class="n">knn5</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;libpysal.weights.distance.KNN at 0x7fba34e3dfd0&gt;
</pre></div>
</div>
</div>
</div>
<p>Note how we need to specify the number of nearest neighbors we want to consider with the argument <code class="docutils literal notranslate"><span class="pre">k</span></code>. Since it is a polygon shapefile that we are passing, the function will automatically compute the centroids to derive distances between observations. Alternatively, we can provide the points in the form of an array, skipping this way the dependency of a file on disk:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Extract centroids</span>
<span class="n">cents</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">centroid</span>
<span class="c1"># Extract coordinates into an array</span>
<span class="n">pts</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
    <span class="p">{</span><span class="s2">&quot;X&quot;</span><span class="p">:</span> <span class="n">cents</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="s2">&quot;Y&quot;</span><span class="p">:</span> <span class="n">cents</span><span class="o">.</span><span class="n">y</span><span class="p">}</span>
<span class="p">)</span><span class="o">.</span><span class="n">values</span>
<span class="c1"># Compute KNN weights</span>
<span class="n">knn5_from_pts</span> <span class="o">=</span> <span class="n">weights</span><span class="o">.</span><span class="n">KNN</span><span class="o">.</span><span class="n">from_array</span><span class="p">(</span><span class="n">pts</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
<span class="n">knn5_from_pts</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;libpysal.weights.distance.KNN at 0x7fba386707f0&gt;
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p><strong>Distance band</strong></p></li>
</ul>
<p>Another approach to build distance-based spatial weights matrices is to draw a circle of certain radious and consider neighbor every observation that falls within the circle. The technique has two main variations: binary and continuous. In the former one, every neighbor is given a weight of one, while in the second one, the weights can be further tweaked by the distance to the observation of interest.</p>
<p>To compute binary distance matrices in <code class="docutils literal notranslate"><span class="pre">PySAL</span></code>, we can use the following command:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">w_dist1kmB</span> <span class="o">=</span> <span class="n">weights</span><span class="o">.</span><span class="n">DistanceBand</span><span class="o">.</span><span class="n">from_dataframe</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/opt/conda/lib/python3.8/site-packages/libpysal/weights/weights.py:172: UserWarning: The weights matrix is not fully connected: 
 There are 2 disconnected components.
  warnings.warn(message)
</pre></div>
</div>
</div>
</div>
<p>This creates a binary matrix that considers neighbors of an observation every polygon whose centroid is closer than 1,000 metres (1Km) of the centroid of such observation. Check, for example, the neighborhood of polygon <code class="docutils literal notranslate"><span class="pre">E01006690</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">w_dist1kmB</span><span class="p">[</span><span class="s1">&#39;E01006690&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;E01006691&#39;: 1.0,
 &#39;E01006692&#39;: 1.0,
 &#39;E01006695&#39;: 1.0,
 &#39;E01006697&#39;: 1.0,
 &#39;E01006720&#39;: 1.0,
 &#39;E01006725&#39;: 1.0,
 &#39;E01006726&#39;: 1.0,
 &#39;E01033763&#39;: 1.0}
</pre></div>
</div>
</div>
</div>
<p>Note that the units in which you specify the distance directly depend on the CRS in which the spatial data are projected, and this has nothing to do with the weights building but it can affect it significantly. Recall how you can check the CRS of a <code class="docutils literal notranslate"><span class="pre">GeoDataFrame</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="o">.</span><span class="n">crs</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;Projected CRS: PROJCS[&quot;Transverse_Mercator&quot;,GEOGCS[&quot;GCS_OSGB 1936 ...&gt;
Name: Transverse_Mercator
Axis Info [cartesian]:
- [east]: Easting (metre)
- [north]: Northing (metre)
Area of Use:
- undefined
Coordinate Operation:
- name: unnamed
- method: Transverse Mercator
Datum: OSGB 1936
- Ellipsoid: Airy 1830
- Prime Meridian: Greenwich
</pre></div>
</div>
</div>
</div>
<p>In this case, you can see the unit is expressed in metres (<code class="docutils literal notranslate"><span class="pre">m</span></code>), hence we set the threshold to 1,000 for a circle of 1km of radious.</p>
<p>An extension of the weights above is to introduce further detail by assigning different weights to different neighbors within the radious circle based on how far they are from the observation of interest. For example, we could think of assigning the inverse of the distance between observations <span class="math notranslate nohighlight">\(i\)</span> and <span class="math notranslate nohighlight">\(j\)</span> as <span class="math notranslate nohighlight">\(w_{ij}\)</span>. This can be computed with the following command:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">w_dist1kmC</span> <span class="o">=</span> <span class="n">weights</span><span class="o">.</span><span class="n">DistanceBand</span><span class="o">.</span><span class="n">from_dataframe</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="mi">1000</span><span class="p">,</span> <span class="n">binary</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/opt/conda/lib/python3.8/site-packages/scipy/sparse/data.py:117: RuntimeWarning: divide by zero encountered in reciprocal
  return self._with_data(data ** n)
</pre></div>
</div>
</div>
</div>
<p>In <code class="docutils literal notranslate"><span class="pre">w_dist1kmC</span></code>, every observation within the 1km circle is assigned a weight equal to the inverse distance between the two:</p>
<div class="math notranslate nohighlight">
\[
w_{ij} = \dfrac{1}{d_{ij}}
\]</div>
<p>This way, the further apart <span class="math notranslate nohighlight">\(i\)</span> and <span class="math notranslate nohighlight">\(j\)</span> are from each other, the smaller the weight <span class="math notranslate nohighlight">\(w_{ij}\)</span> will be.</p>
<p>Contrast the binary neighborhood with the continuous one for <code class="docutils literal notranslate"><span class="pre">E01006690</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">w_dist1kmC</span><span class="p">[</span><span class="s1">&#39;E01006690&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;E01006691&#39;: 0.001320115452290246,
 &#39;E01006692&#39;: 0.0016898106255168294,
 &#39;E01006695&#39;: 0.001120923796462639,
 &#39;E01006697&#39;: 0.001403469553911711,
 &#39;E01006720&#39;: 0.0013390451319917913,
 &#39;E01006725&#39;: 0.001009044334260805,
 &#39;E01006726&#39;: 0.0010528395831202145,
 &#39;E01033763&#39;: 0.0012983249272553688}
</pre></div>
</div>
</div>
</div>
<p>Following this logic of more detailed weights through distance, there is a temptation to take it further and consider everyone else in the dataset as a neighbor whose weight will then get modulated by the distance effect shown above. However, although conceptually correct, this approach is not always the most computationally or practical one. Because of the nature of spatial weights matrices, particularly because of the fact their size is <span class="math notranslate nohighlight">\(N\)</span> by <span class="math notranslate nohighlight">\(N\)</span>, they can grow substantially large. A way to cope with this problem is by making sure they remain fairly <em>sparse</em> (with many zeros). Sparsity is typically ensured in the case of contiguity or KNN by construction but, with inverse distance, it needs to be imposed as, otherwise, the matrix could be potentially entirely dense (no zero values other than the diagonal). In practical terms, what is usually done is to impose a distance threshold beyond which no weight is assigned and interaction is assumed to be non-existent. Beyond being computationally feasible and scalable, results from this approach usually do not differ much from a fully “dense” one as the additional information that is included from further observations is almost ignored due to the small weight they receive. In this context, a commonly used threshold, although not always best, is that which makes every observation to have at least one neighbor.</p>
<p>Such a threshold can be calculated as follows:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">min_thr</span> <span class="o">=</span> <span class="n">weights</span><span class="o">.</span><span class="n">min_threshold_distance</span><span class="p">(</span><span class="n">pts</span><span class="p">)</span>
<span class="n">min_thr</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>939.7373992113434
</pre></div>
</div>
</div>
</div>
<p>Which can then be used to calculate an inverse distance weights matrix:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">w_min_dist</span> <span class="o">=</span> <span class="n">weights</span><span class="o">.</span><span class="n">DistanceBand</span><span class="o">.</span><span class="n">from_dataframe</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">min_thr</span><span class="p">,</span> <span class="n">binary</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="block-weights">
<h3>Block weights<a class="headerlink" href="#block-weights" title="Permalink to this headline">#</a></h3>
<p>Block weights connect every observation in a dataset that belongs to the same category in a list provided ex-ante. Usually, this list will have some relation to geography an the location of the observations but, technically speaking, all one needs to create block weights is a list of memberships. In this class of weights, neighboring observations, those in the same group, are assigned a weight of one, and the rest receive a weight of zero.</p>
<p>In this example, we will build a spatial weights matrix that connects every LSOA with all the other ones in the same MSOA. See how the MSOA code is expressed for every LSOA:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>LSOA11CD</th>
      <th>MSOA11CD</th>
      <th>geometry</th>
    </tr>
    <tr>
      <th>LSOA11CD</th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>E01006512</th>
      <td>E01006512</td>
      <td>E02001377</td>
      <td>POLYGON ((336103.358 389628.580, 336103.416 38...</td>
    </tr>
    <tr>
      <th>E01006513</th>
      <td>E01006513</td>
      <td>E02006932</td>
      <td>POLYGON ((335173.781 389691.538, 335169.798 38...</td>
    </tr>
    <tr>
      <th>E01006514</th>
      <td>E01006514</td>
      <td>E02001383</td>
      <td>POLYGON ((335495.676 389697.267, 335495.444 38...</td>
    </tr>
    <tr>
      <th>E01006515</th>
      <td>E01006515</td>
      <td>E02001383</td>
      <td>POLYGON ((334953.001 389029.000, 334951.000 38...</td>
    </tr>
    <tr>
      <th>E01006518</th>
      <td>E01006518</td>
      <td>E02001390</td>
      <td>POLYGON ((335354.015 388601.947, 335354.000 38...</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>To build a block spatial weights matrix that connects as neighbors all the LSOAs in the same MSOA, we only require the mapping of codes. Using <code class="docutils literal notranslate"><span class="pre">PySAL</span></code>, this is a one-line task:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">w_block</span> <span class="o">=</span> <span class="n">weights</span><span class="o">.</span><span class="n">block_weights</span><span class="p">(</span><span class="n">db</span><span class="p">[</span><span class="s1">&#39;MSOA11CD&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/opt/conda/lib/python3.8/site-packages/libpysal/weights/weights.py:172: UserWarning: The weights matrix is not fully connected: 
 There are 61 disconnected components.
  warnings.warn(message)
</pre></div>
</div>
</div>
</div>
<p>In this case, <code class="docutils literal notranslate"><span class="pre">PySAL</span></code> does not allow to pass the argument <code class="docutils literal notranslate"><span class="pre">idVariable</span></code> as above. As a result, observations are named after the order the occupy in the list:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">w_block</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{218: 1.0, 219: 1.0, 220: 1.0, 292: 1.0}
</pre></div>
</div>
</div>
</div>
<p>The first element is neighbor of observations 218, 129, 220, and 292, all of them with an assigned weight of 1. However, it is possible to correct this by using the additional method <code class="docutils literal notranslate"><span class="pre">remap_ids</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">w_block</span><span class="o">.</span><span class="n">remap_ids</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Now if you try <code class="docutils literal notranslate"><span class="pre">w_bloc[0]</span></code>, it will return an error. But if you query for the neighbors of an observation by its LSOA id, it will work:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">w_block</span><span class="p">[</span><span class="s1">&#39;E01006512&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;E01006747&#39;: 1.0, &#39;E01006748&#39;: 1.0, &#39;E01006751&#39;: 1.0, &#39;E01033763&#39;: 1.0}
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="standardizing-w-matrices">
<h2>Standardizing <code class="docutils literal notranslate"><span class="pre">W</span></code> matrices<a class="headerlink" href="#standardizing-w-matrices" title="Permalink to this headline">#</a></h2>
<p>In the context of many spatial analysis techniques, a spatial weights matrix with raw values (e.g. ones and zeros for the binary case) is not always the best suiting one for analysis and some sort of transformation is required. This implies modifying each weight so they conform to certain rules. <code class="docutils literal notranslate"><span class="pre">PySAL</span></code> has transformations baked right into the <code class="docutils literal notranslate"><span class="pre">W</span></code> object, so it is possible to check the state of an object as well as to modify it.</p>
<p>Consider the original queen weights, for observation <code class="docutils literal notranslate"><span class="pre">E01006690</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">w_queen</span><span class="p">[</span><span class="s1">&#39;E01006690&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;E01006697&#39;: 1.0,
 &#39;E01006692&#39;: 1.0,
 &#39;E01033763&#39;: 1.0,
 &#39;E01006759&#39;: 1.0,
 &#39;E01006695&#39;: 1.0,
 &#39;E01006720&#39;: 1.0,
 &#39;E01006691&#39;: 1.0}
</pre></div>
</div>
</div>
</div>
<p>Since it is contiguity, every neighbor gets one, the rest zero weight. We can check if the object <code class="docutils literal notranslate"><span class="pre">w_queen</span></code> has been transformed or not by calling the argument <code class="docutils literal notranslate"><span class="pre">transform</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">w_queen</span><span class="o">.</span><span class="n">transform</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;O&#39;
</pre></div>
</div>
</div>
</div>
<p>where <code class="docutils literal notranslate"><span class="pre">O</span></code> stands for “original”, so no transformations have been applied yet. If we want to apply a row-based transformation, so every row of the matrix sums up to one, we modify the <code class="docutils literal notranslate"><span class="pre">transform</span></code> attribute as follows:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">w_queen</span><span class="o">.</span><span class="n">transform</span> <span class="o">=</span> <span class="s1">&#39;R&#39;</span>
</pre></div>
</div>
</div>
</div>
<p>Now we can check the weights of the same observation as above and find they have been modified:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">w_queen</span><span class="p">[</span><span class="s1">&#39;E01006690&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;E01006697&#39;: 0.14285714285714285,
 &#39;E01006692&#39;: 0.14285714285714285,
 &#39;E01033763&#39;: 0.14285714285714285,
 &#39;E01006759&#39;: 0.14285714285714285,
 &#39;E01006695&#39;: 0.14285714285714285,
 &#39;E01006720&#39;: 0.14285714285714285,
 &#39;E01006691&#39;: 0.14285714285714285}
</pre></div>
</div>
</div>
</div>
<p>Save for precission issues, the sum of weights for all the neighbors is one:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">w_queen</span><span class="p">[</span><span class="s1">&#39;E01006690&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.9999999999999998
</pre></div>
</div>
</div>
</div>
<p>Returning the object back to its original state involves assigning <code class="docutils literal notranslate"><span class="pre">transform</span></code> back to original:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">w_queen</span><span class="o">.</span><span class="n">transform</span> <span class="o">=</span> <span class="s1">&#39;O&#39;</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">w_queen</span><span class="p">[</span><span class="s1">&#39;E01006690&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;E01006697&#39;: 1.0,
 &#39;E01006692&#39;: 1.0,
 &#39;E01033763&#39;: 1.0,
 &#39;E01006759&#39;: 1.0,
 &#39;E01006695&#39;: 1.0,
 &#39;E01006720&#39;: 1.0,
 &#39;E01006691&#39;: 1.0}
</pre></div>
</div>
</div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">PySAL</span></code> supports the following transformations:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">O</span></code>: original, returning the object to the initial state.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">B</span></code>: binary, with every neighbor having assigned a weight of one.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">R</span></code>: row, with all the neighbors of a given observation adding up to one.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">V</span></code>: variance stabilizing, with the sum of all the weights being constrained to the number of observations.</p></li>
</ul>
</section>
<section id="reading-and-writing-spatial-weights-in-pysal">
<h2>Reading and Writing spatial weights in <code class="docutils literal notranslate"><span class="pre">PySAL</span></code><a class="headerlink" href="#reading-and-writing-spatial-weights-in-pysal" title="Permalink to this headline">#</a></h2>
<p>Sometimes, if a dataset is very detailed or large, it can be costly to build the spatial weights matrix of a given geography and, despite the optimizations in the <code class="docutils literal notranslate"><span class="pre">PySAL</span></code> code, the computation time can quickly grow out of hand. In these contexts, it is useful to not have to re-build a matrix from scratch every time we need to re-run the analysis. A useful solution in this case is to build the matrix once, and save it to a file where it can be reloaded at a later stage if needed.</p>
<p><code class="docutils literal notranslate"><span class="pre">PySAL</span></code> has a common way to write any kind of <code class="docutils literal notranslate"><span class="pre">W</span></code> object into a file using the command <code class="docutils literal notranslate"><span class="pre">open</span></code>. The only element we need to decide for ourselves beforehand is the format of the file. Although there are several formats in which spatial weight matrices can be stored, we will focused on the two most commonly used ones:</p>
<ul class="simple">
<li><p><strong><code class="docutils literal notranslate"><span class="pre">.gal</span></code></strong> files for contiguity weights</p></li>
</ul>
<p>Contiguity spatial weights can be saved into a <code class="docutils literal notranslate"><span class="pre">.gal</span></code> file with the following commands:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Open file to write into</span>
<span class="n">fo</span> <span class="o">=</span> <span class="n">psopen</span><span class="p">(</span><span class="s1">&#39;imd_queen.gal&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
<span class="c1"># Write the matrix into the file</span>
<span class="n">fo</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">w_queen</span><span class="p">)</span>
<span class="c1"># Close the file</span>
<span class="n">fo</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>The process is composed by the following three steps:</p>
<ol class="arabic simple">
<li><p>Open a target file for <code class="docutils literal notranslate"><span class="pre">w</span></code>riting the matrix, hence the <code class="docutils literal notranslate"><span class="pre">w</span></code> argument. In this case, if a file <code class="docutils literal notranslate"><span class="pre">imd_queen.gal</span></code> already exists, it will be overwritten, so be careful.</p></li>
<li><p>Write the <code class="docutils literal notranslate"><span class="pre">W</span></code> object into the file.</p></li>
<li><p>Close the file. This is important as some additional information is written into the file at this stage, so failing to close the file might have unintended consequences.</p></li>
</ol>
<p>Once we have the file written, it is possible to read it back into memory with the following command:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">w_queen2</span> <span class="o">=</span> <span class="n">psopen</span><span class="p">(</span><span class="s1">&#39;imd_queen.gal&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
<span class="n">w_queen2</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;libpysal.weights.weights.W at 0x7fba351d76a0&gt;
</pre></div>
</div>
</div>
</div>
<p>Note how we now use <code class="docutils literal notranslate"><span class="pre">r</span></code> instead of <code class="docutils literal notranslate"><span class="pre">w</span></code> because we are <code class="docutils literal notranslate"><span class="pre">r</span></code>eading the file, and also notice how we open the file and, in the same line, we call <code class="docutils literal notranslate"><span class="pre">read()</span></code> directly.</p>
<ul class="simple">
<li><p><strong><code class="docutils literal notranslate"><span class="pre">.gwt</span></code></strong> files for distance-based weights.</p></li>
</ul>
<p>A very similar process to the one above can be used to read and write distance based weights. The only difference is specifying the right file format, <code class="docutils literal notranslate"><span class="pre">.gwt</span></code> in this case. So, if we want to write <code class="docutils literal notranslate"><span class="pre">w_dist1km</span></code> into a file, we will run:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Open file</span>
<span class="n">fo</span> <span class="o">=</span> <span class="n">psopen</span><span class="p">(</span><span class="s1">&#39;imd_dist1km.gwt&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
<span class="c1"># Write matrix into the file</span>
<span class="n">fo</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">w_dist1kmC</span><span class="p">)</span>
<span class="c1"># Close file</span>
<span class="n">fo</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>And if we want to read the file back in, all we need to do is:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">w_dist1km2</span> <span class="o">=</span> <span class="n">psopen</span><span class="p">(</span><span class="s1">&#39;imd_dist1km.gwt&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/opt/conda/lib/python3.8/site-packages/libpysal/io/iohandlers/gwt.py:204: RuntimeWarning: DBF relating to GWT was not found, proceeding with unordered string IDs.
  warn(msg, RuntimeWarning)
/opt/conda/lib/python3.8/site-packages/libpysal/weights/weights.py:172: UserWarning: The weights matrix is not fully connected: 
 There are 2 disconnected components.
  warnings.warn(message)
</pre></div>
</div>
</div>
</div>
<p>Note how, in this case, you will probably receive a warning alerting you that there was not a <code class="docutils literal notranslate"><span class="pre">DBF</span></code> relating to the file. This is because, by default, <code class="docutils literal notranslate"><span class="pre">PySAL</span></code> takes the order of the observations in a <code class="docutils literal notranslate"><span class="pre">.gwt</span></code> from a shapefile. If this is not provided, <code class="docutils literal notranslate"><span class="pre">PySAL</span></code> cannot entirely determine all the elements and hence the resulting <code class="docutils literal notranslate"><span class="pre">W</span></code> might not be complete (islands, for example, can be missing). To fully complete the reading of the file, we can remap the ids as we have seen above:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">w_dist1km2</span><span class="o">.</span><span class="n">remap_ids</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="spatial-lag">
<h2>Spatial Lag<a class="headerlink" href="#spatial-lag" title="Permalink to this headline">#</a></h2>
<p>One of the most direct applications of spatial weight matrices is the so-called <em>spatial lag</em>. The spatial lag of a given variable is the product of a spatial weight matrix and the variable itself:</p>
<div class="math notranslate nohighlight">
\[
Y_{sl} = W Y
\]</div>
<p>where <span class="math notranslate nohighlight">\(Y\)</span> is a Nx1 vector with the values of the variable. Recall that the product of a matrix and a vector equals the sum of a row by column element multiplication for the resulting value of a given row. In terms of the spatial lag:</p>
<div class="math notranslate nohighlight">
\[
y_{sl-i} = \displaystyle \sum_j w_{ij} y_j
\]</div>
<p>If we are using row-standardized weights, <span class="math notranslate nohighlight">\(w_{ij}\)</span> becomes a proportion between zero and one, and <span class="math notranslate nohighlight">\(y_{sl-i}\)</span> can be seen as the average value of <span class="math notranslate nohighlight">\(Y\)</span> in the neighborhood of <span class="math notranslate nohighlight">\(i\)</span>.</p>
<p>For this illustration, we will use the area of each polygon as the variable of interest. And to make things a bit nicer later on, we will keep the log of the area instead of the raw measurement. Hence, let’s create a column for it:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="p">[</span><span class="s2">&quot;area&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">area</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>The spatial lag is a key element of many spatial analysis techniques, as we will see later on and, as such, it is fully supported in <code class="docutils literal notranslate"><span class="pre">PySAL</span></code>. To compute the spatial lag of a given variable, <code class="docutils literal notranslate"><span class="pre">area</span></code> for example:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Row-standardize the queen matrix</span>
<span class="n">w_queen</span><span class="o">.</span><span class="n">transform</span> <span class="o">=</span> <span class="s1">&#39;R&#39;</span>
<span class="c1"># Compute spatial lag of `area`</span>
<span class="n">w_queen_score</span> <span class="o">=</span> <span class="n">weights</span><span class="o">.</span><span class="n">lag_spatial</span><span class="p">(</span><span class="n">w_queen</span><span class="p">,</span> <span class="n">db</span><span class="p">[</span><span class="s2">&quot;area&quot;</span><span class="p">])</span>
<span class="c1"># Print the first five elements</span>
<span class="n">w_queen_score</span><span class="p">[:</span><span class="mi">5</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([12.40660189, 12.54225296, 12.28284814, 12.61675295, 12.55042815])
</pre></div>
</div>
</div>
</div>
<p>Line 4 contains the actual computation, which is highly optimized in <code class="docutils literal notranslate"><span class="pre">PySAL</span></code>. Note that, despite passing in a <code class="docutils literal notranslate"><span class="pre">pd.Series</span></code> object, the output is a <code class="docutils literal notranslate"><span class="pre">numpy</span></code> array. This however, can be added directly to the table <code class="docutils literal notranslate"><span class="pre">db</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="p">[</span><span class="s1">&#39;w_area&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">w_queen_score</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="moran-plot">
<h2>Moran Plot<a class="headerlink" href="#moran-plot" title="Permalink to this headline">#</a></h2>
<p>The Moran Plot is a graphical way to start exploring the concept of spatial autocorrelation, and it is a good application of spatial weight matrices and the spatial lag. In essence, it is a standard scatter plot in which a given variable (<code class="docutils literal notranslate"><span class="pre">area</span></code>, for example) is plotted against <em>its own</em> spatial lag. Usually, a fitted line is added to include more information:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Setup the figure and axis</span>
<span class="n">f</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="mi">9</span><span class="p">))</span>
<span class="c1"># Plot values</span>
<span class="n">sns</span><span class="o">.</span><span class="n">regplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">&quot;area&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;w_area&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">db</span><span class="p">,</span> <span class="n">ci</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
<span class="c1"># Display</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/62625e9525b3cfbc7b44cd71233d42f291f23c03427f570d5c01264cd1628c56.png" src="../../_images/62625e9525b3cfbc7b44cd71233d42f291f23c03427f570d5c01264cd1628c56.png" />
</div>
</div>
<p>In order to easily compare different scatter plots and spot outlier observations, it is common practice to standardize the values of the variable before computing its spatial lag and plotting it. This can be accomplished by substracting the average value and dividing the result by the standard deviation:</p>
<div class="math notranslate nohighlight">
\[
z_i = \dfrac{y - \bar{y}}{\sigma_y}
\]</div>
<p>where <span class="math notranslate nohighlight">\(z_i\)</span> is the standardized version of <span class="math notranslate nohighlight">\(y_i\)</span>, <span class="math notranslate nohighlight">\(\bar{y}\)</span> is the average of the variable, and <span class="math notranslate nohighlight">\(\sigma\)</span> its standard deviation.</p>
<p>Creating a standardized Moran Plot implies that average values are centered in the plot (as they are zero when standardized) and dispersion is expressed in standard deviations, with the rule of thumb of values greater or smaller than two standard deviations being <em>outliers</em>. A standardized Moran Plot also partitions the space into four quadrants that represent different situations:</p>
<ol class="arabic simple">
<li><p>High-High (<em>HH</em>): values above average surrounded by values above average.</p></li>
<li><p>Low-Low (<em>LL</em>): values below average surrounded by values below average.</p></li>
<li><p>High-Low (<em>HL</em>): values above average surrounded by values below average.</p></li>
<li><p>Low-High (<em>LH</em>): values below average surrounded by values above average.</p></li>
</ol>
<p>These will be further explored once spatial autocorrelation has been properly introduced in subsequent blocks.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Standardize the area</span>
<span class="n">std_db</span> <span class="o">=</span> <span class="p">(</span><span class="n">db</span><span class="p">[</span><span class="s1">&#39;area&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">db</span><span class="p">[</span><span class="s1">&#39;area&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span> <span class="o">/</span> <span class="n">db</span><span class="p">[</span><span class="s1">&#39;area&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
<span class="c1"># Compute the spatial lag of the standardized version and save is as a </span>
<span class="c1"># Series indexed as the original variable</span>
<span class="n">std_w_db</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span>
    <span class="n">weights</span><span class="o">.</span><span class="n">lag_spatial</span><span class="p">(</span><span class="n">w_queen</span><span class="p">,</span> <span class="n">std_db</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="n">std_db</span><span class="o">.</span><span class="n">index</span>
<span class="p">)</span>
<span class="c1"># Setup the figure and axis</span>
<span class="n">f</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="mi">9</span><span class="p">))</span>
<span class="c1"># Plot values</span>
<span class="n">sns</span><span class="o">.</span><span class="n">regplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">std_db</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">std_w_db</span><span class="p">,</span> <span class="n">ci</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
<span class="c1"># Add vertical and horizontal lines</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="c1"># Display</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/416c725ea817a60756c8051640de820c9504cf1208039de1d67446016360fa03.png" src="../../_images/416c725ea817a60756c8051640de820c9504cf1208039de1d67446016360fa03.png" />
</div>
</div>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./content/bE"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
                <footer class="bd-footer-article">
                  
<div class="footer-article-items footer-article__inner">
  
    <div class="footer-article-item"><!-- Previous / next buttons -->
<div class="prev-next-area">
    <a class="left-prev"
       href="concepts_E.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Concepts</p>
      </div>
    </a>
    <a class="right-next"
       href="diy_E.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Do-It-Yourself</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div></div>
  
</div>

                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">

  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#spatial-weights">Spatial weights</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#data">Data</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#building-spatial-weights-in-pysal">Building spatial weights in <code class="docutils literal notranslate"><span class="pre">PySAL</span></code></a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#contiguity">Contiguity</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#distance">Distance</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#block-weights">Block weights</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#standardizing-w-matrices">Standardizing <code class="docutils literal notranslate"><span class="pre">W</span></code> matrices</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#reading-and-writing-spatial-weights-in-pysal">Reading and Writing spatial weights in <code class="docutils literal notranslate"><span class="pre">PySAL</span></code></a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#spatial-lag">Spatial Lag</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#moran-plot">Moran Plot</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Dani Arribas-Bel
</p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
<div class="extra_footer">
  <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-sa/4.0/88x31.png" /></a><br /><span xmlns:dct="http://purl.org/dc/terms/" property="dct:title">A course on Geographic Data Science</span> by <a xmlns:cc="http://creativecommons.org/ns#" href="http://darribas.org" property="cc:attributionName" rel="cc:attributionURL">Dani Arribas-Bel</a> is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 International License</a>.

</div>
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/bootstrap.js?digest=e353d410970836974a52"></script>
<script src="../../_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>